{
    "Slug": "ai-helped-troubleshoot-an-intermittent-sql-database-performance-issue-in-one-day",
    "Title": "AI helps troubleshoot an intermittent SQL Database performance issue in one day",
    "Summary": "In this blogpost, you will learn how Azure SQL Database intelligent performance feature Intelligent Insights has successfully helped a customer troubleshoot a hard to find 6-month intermittent database performance issue in a single day only. ",
    "Content": "<p>In this blogpost, you will learn how Azure SQL Database intelligent performance feature <a href=\"https://docs.microsoft.com/en-us/azure/sql-database/sql-database-intelligent-insights\" target=\"_blank\">Intelligent Insights</a> has successfully helped a customer troubleshoot a hard to find 6-month intermittent database performance issue in a single day only. You will find out how Intelligent Insights helps an ISV operate 60,000 databases by identifying related performance issues across their database fleet. You will also learn how Intelligent Insights helped an enterprise seamlessly identify a hard to troubleshoot performance degradation issue on a large-scale 35TB database fleet.</p>\n\n<p>Azure SQL Database, the most intelligent cloud database, is empowering small and medium size business, and large enterprises to focus on writing awesome applications while entrusting Azure to autonomously take care of running, scaling, and maintain a peak performance with a minimum of human interaction, or advanced technical skill set required.</p>\n\n<p>Intelligent Insights is a new disruptive intelligent performance technology leveraging the power of artificial intelligence (AI) to continuously monitor and troubleshoot Azure SQL Database performance issues with a pinpoint accuracy and at a large scale simply not possible before. Performance <a href=\"https://docs.microsoft.com/en-us/azure/sql-database/sql-database-intelligent-insights-troubleshoot-performance\" target=\"_blank\">troubleshooting models</a> for the solution where fine-tuned and advanced based on the learning from a massive workload pool of several million Azure SQL Databases.</p>\n\n<p>In the period since its public preview debut in Sep. 2017, we have witnessed some remarkable customer success stories with Intelligent Insights that I would like to share with you.</p>\n\n<h2>Troubleshooting hard-to-find intermittent SQL Database performance issues</h2>\n\n<p><a href=\"https://neworbit.co.uk/\" target=\"_blank\">NewOrbit</a> is an ISV based in the United Kingdom building and running software on Azure for startups and enterprises, including a system for background checking of employees and tenants. Thousands of customers check more than 400,000 people each year and the system does that through integrating information from various services. NewOrbit runs entirely on Azure and use about 200 SQL Databases. NewOrbit has a flat organizational structure consisting of developers and customer account managers only. They do not employ DevOps team or DBAs as they rely on SQL Database built-in intelligence to automatically tune and troubleshoot database performance for them as NewOrbit CTO Frans Lytzen is saying &ldquo;I have Azure for that&rdquo;.</p>\n\n<p>NewOrbit experienced an intermittent performance issue lasting for about 6 months that resulted in getting an increased amount of timeouts for existing systems running in production. Their first reaction was to upgrade to a higher pricing tier on Azure with more capacity, however this did not help and it seemed very strange to them. As they&rsquo;ve seen more than enough spare DTUs on their Azure subscription, NewOrbit understood right away that dialing up the capacity will not make the issue go away.</p>\n\n<p>NewOrbit has decided to try Intelligent Insights. As soon as they fired up the solution, it showed that there seems to exist a memory pressure on their databases. This was not immediately obvious and NewOrbit understood that memory pressure is not the cause but most likely an effect of another underlying problem.</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/d383494b-e8f2-4b32-a450-1eb5755f174d.png\"><img alt=\"image_000\" border=\"0\" height=\"622\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/fba91a9f-1d3b-458b-a937-9e8eab00676a.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"image_000\" width=\"977\"></a></p>\n\n<p>Intelligent Insights has within a day of being turned on pointed out there are several queries suspected as a root cause for the memory pressure. NewOrbit has promptly fixed and deployed new queries to production witnessing an immediate decrease in memory pressure the following day.</p>\n\n<p><em>&ldquo;On an earlier occasion, we had a performance issue lasting for about 6 months. Before Intelligent Insights we have not had a way of figuring out where do we even start troubleshooting. Intelligent Insights gave us a list of things to do. What Intelligent Insight does is that it enables us to pinpoint where the problem is and to get a fix deployed within 24hrs.&rdquo;</em></p>\n\n<p align=\"right\">Frans Lytzen, CTO, NewOrbit.</p>\n\n<p>As NewOrbit grows as a service, their databases and queries are getting bigger and the complexity grows. They have now implemented a continuous improvement program relying on Intelligent Insights to regularly review and optimize database queries for the best performance of their applications.</p>\n\n<h2>Identifying performance issues in the sea of 60,000 SQL Databases</h2>\n\n<p><a href=\"https://docs.microsoft.com/en-us/azure/sql-database/sql-database-implementation-snelstart\" target=\"_blank\">SnelStart</a> is a Dutch ISV developing and running SaaS service for small and large companies providing financial online services such are bookkeeping, invoicing and accounting. SnelStart relies on Azure to deliver their service to about 64,000 customers. The underlying infrastructure employs 60,000+ SQL Databases, mainly in elastic pools. Maintaining a massive amount of databases at scale and quickly reacting to customer issues, especially in cases of services degradation or an outage is an imperative for SnelStart.</p>\n\n<p>To maintain such a large amount of databases typically involves having a large DBA and DevOps team. Once a customer calls on the phone complaining that the service is slow or unavailable, SnelStart team needs to quickly identify and act on resolving the issue. The company had a number of cases where it would find out about a performance or unavailability issues from their customers first. Hoping to improve their response time, SnelStart has decided to use Intelligent Insights as a performance-monitoring tool.</p>\n\n<p>SnelStart uses the solution daily to help identify elastic pools hitting its CPU limits. The built-in intelligence helps the company identify top consuming databases in overutilized elastic pools, providing suggestions of other elastic pools with sufficient capacity where the hot databases could be moved. SnelStart as their DevOps strategy has created separate elastic pools on each of their logical servers where they move high consuming databases. This allows the company to research slow running queries, and other database problems with the help of <a href=\"https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-azure-sql\" target=\"_blank\">Azure SQL Analytics</a> until repaired. Once performance of hot databases has improved, SnelStart typically returns them back to the original elastic pools.</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/fb074cfc-683d-47f4-af35-603cf729ef2b.png\"><img alt=\"image_002\" border=\"0\" height=\"448\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a8d922da-0a18-4afb-9252-19f42d316f7a.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"image_002\" width=\"1085\"></a></p>\n\n<p>With the help of Intelligent Insights, SnelStart was also, in one of the instances, able to quickly identify application queries causing database locking, much before their developers could manually troubleshoot the root cause of the issue. Hotfix for the issue was deployed within minutes, and before customers were impacted at scale. Better yet, there were no customer phone calls received regarding the service performance.</p>\n\n<p>This was an entirely new type of capability for the company, as the service monitoring has shifted from a reactive to proactive relying on SQL Database built-in intelligent performance.</p>\n\n<p><em>&ldquo;Intelligent Insights proactively finds a database performance problem in a more efficient way and much faster than humans. With it we can proactively help customers until we have a fix for the problem.&rdquo;</em></p>\n\n<p align=\"right\">Bauke Stil, Application Manager, SnelStart.</p>\n\n<p>SnelStart was impressed with the efficiency of detecting database performance issues automatically and at such scale in the sea of 60,000 SQL Databases. As all of their customer databases are having the same structure, the company is also using the solution to identify and resolve common performance issues across their entire database fleet. Once an issue is identified on one database, a hotfix is deployed to all databases immediately benefiting all SnelStart customers.</p>\n\n<h2>Finding a locking issue on a large-scale 35TB SQL Database fleet</h2>\n\n<p><a href=\"https://visualstudio.microsoft.com/tfs/\" target=\"_blank\">Microsoft TFS</a> provides an online service supporting our developer community and customers. It is a complex system handling trillion lines of code across the customer base. The service provides sophisticated reporting, builds, labs, tests, ticketing, release automation management and project management &ndash; amongst others. Providing a 24/7/365 service globally with a top performance is imperative for TFS. Once you click to check-in your code, or if you are perhaps creating a TFS ticket, you expect a prompt response from the service. TFS massive infrastructure runs on about 900 SQL Databases with combined 35TB of data stored.</p>\n\n<p>TFS has previously used its own monitoring and alerting solution capable of observing slow queries and sustained high CPU periods. On one of the occasions, the existing tools identified a performance issue providing only a shallow analysis that there exists a heavy locking on a database, but nothing else. Further troubleshooting has indicated the locking was table scoped and related to lock partitioning. This meant that the affected slow query visible in the stats is typically not the root cause of locking, but only a surface effect of some other blocking query causing the locking. The workload in such cases keeps on piling up, so upgrading to a larger resource pool could only be a short-lived solution. The only way out of this was to find the blocking query and to fix it.</p>\n\n<p>Troubleshooting in cases such as this one is typically very difficult, as it requires considerable DBA skills and it is very time consuming. TFS turned to Intelligent Insights to help with performance troubleshooting automation. In this particular case, the system has identified application related increase in the workload pile up, and has provided a list the affected and blocking queries.</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0c6bb9ff-07bc-40b6-a0d5-abbb8f7a85ae.png\"><img alt=\"image_003\" border=\"0\" height=\"382\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/63f54d00-ffce-4beb-b91c-9be439ad05c1.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"image_003\" width=\"974\"></a></p>\n\n<p>Analysis of the blocking query has identified that this was a maintenance query scheduled periodically to remove unused attachments. Further analyzing the code, it was determined that the size of the deletion batch was too large causing the issue. New query with reduced batch size was deployed promptly, having an immediate effect in resolving the heavy locking and gradually relieving the workload pressure.</p>\n\n<p>Maintaining TFS demanding infrastructure requires some of the best Microsoft engineers on the job. We have surely met the bar with one of the best SQL performance troubleshooters at Microsoft, Remi Lemarchand, Principal Software Engineer at TFS, hearing him say:</p>\n\n<p><em>&ldquo;Intelligent Insights does a great job of finding database performance problems. I find it always right on the spot!&rdquo;</em></p>\n\n<p align=\"right\">Remi Lemarchand, Principal Software Engineer, Microsoft TFS.</p>\n\n<p>Remi concludes that he prefers using Intelligent Insights first in troubleshooting database performance issues before moving onto other tools due to the level of depth it provides, and considerable reduction of manual DBA troubleshooting time required. Since applying the fix to the blocking query, the database is purring along nicely!</p>\n\n<h2>Summary</h2>\n\n<p>Marriage of AI and Azure SQL Database has resulted in disruptive new capabilities of intelligent performance not possible before. Small and medium size business can now do more with Azure on a large scale with a smaller crew and at a considerably lower cost compared to running infrastructure on their own. Large companies and enterprises can have less headaches and relieve pressure from their DBAs and DevOps as SQL Database intelligent performance can help them identify operational issues on tens of thousands of databases in a single day, compared to months in some cases.</p>\n\n<p>To help you start using SQL Database Intelligent Insights for troubleshooting performance issues, see <a href=\"https://docs.microsoft.com/en-us/azure/sql-database/sql-database-intelligent-insights\" target=\"_blank\">Setup Intelligent Insights with Log Analytics</a>.</p>\n\n<p>For related SQL Database intelligent performance products, see <a href=\"https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-azure-sql\" target=\"_blank\">Monitor Azure SQL Databases with Azure SQL Analytics</a>, and <a href=\"https://docs.microsoft.com/en-us/azure/sql-database/sql-database-automatic-tuning\" target=\"_blank\">Automatic tuning in Azure SQL Database</a>.</p>\n\n<p>Please let us know how do you envision SQL Database intelligent performance helping you?</p>\n"
}