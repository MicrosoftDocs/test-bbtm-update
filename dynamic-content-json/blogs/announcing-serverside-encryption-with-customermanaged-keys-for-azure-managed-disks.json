{
    "Slug": "announcing-serverside-encryption-with-customermanaged-keys-for-azure-managed-disks",
    "Title": "Announcing server-side encryption with customer-managed keys for Azure Managed Disks",
    "Summary": "Today, we are announcing the general availability for server-side encryption (SSE) with customer-managed keys (CMK) for Azure Managed Disks. Azure customers have benefited from server-side encryption with platform-managed keys for Managed Disks enabled by default.",
    "Content": "<p>Today, we&#39;re announcing the general availability for server-side encryption (SSE) with customer-managed keys (CMK) for Azure Managed Disks. Azure customers already benefit from SSE with <a href=\"https://azure.microsoft.com/en-us/blog/azure-managed-disks-sse/\" target=\"_blank\">platform-managed keys</a>&nbsp;for Managed Disks enabled by default. SSE with CMK improves on platform-managed keys by giving you control of the encryption keys to meet your compliance need.</p>\n\n<p>Today, customers can also use <a href=\"https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption-overview\" target=\"_blank\">Azure Disk Encryption</a>, which leverages the Windows <a href=\"https://docs.microsoft.com/windows/security/information-protection/bitlocker/bitlocker-overview\" target=\"_blank\">BitLocker</a> feature and the Linux <a href=\"https://en.wikipedia.org/wiki/Dm-crypt\" target=\"_blank\">dm-crypt</a> feature to encrypt Managed Disks with CMK within the guest virtual machine (VM). SSE with CMK improves on Azure Disk encryption by enabling you to use any OS types and images, including custom images, for your VMs by encrypting data in the Azure Storage service.</p>\n\n<p>SSE with CMK is integrated with <a href=\"https://azure.microsoft.com/en-us/services/key-vault/\" target=\"_blank\">Azure Key Vault</a>, which provides highly available and scalable secure storage for your keys backed by Hardware Security Modules. You can either <a href=\"https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys\" target=\"_blank\">bring your own keys (BYOK)</a> to your Key Vault or generate new keys in the Key Vault.</p>\n\n<h2>About the key management</h2>\n\n<p>Managed Disks are encrypted and decrypted transparently using 256-bit Advanced Encryption Standard (AES) encryption, one of the strongest block ciphers available. The Storage service handles the encryption and decryption in a fully transparent fashion using envelope encryption. It encrypts data using <a href=\"https://en.wikipedia.org/wiki/Advanced_Encryption_Standard\" target=\"_blank\">256-bit AES-based data encryption keys</a>, which are, in turn, protected using your keys stored in a Key Vault.</p>\n\n<p>The Storage service generates data encryption keys and encrypts them with CMK using RSA encryption. The envelope encryption allows you to rotate (change) your keys periodically as per your compliance policies without impacting your VMs. When you rotate your keys, the Storage service re-encrypts the data encryption keys with the new CMK.</p>\n\n<h2>Full control of your keys</h2>\n\n<p>You are in full control of your keys in your Key Vault. Managed Disks uses <a href=\"https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview\" target=\"_blank\">system-assigned managed identity</a> in your Azure Active Directory (Azure AD) for accessing keys in Key Vault. An administrator with required permissions in the Key Vault must first grant access to Managed Disks in Key Vault to use the keys for encrypting and decrypting the data encryption key. You can prevent Managed Disks from accessing your keys by either disabling your keys or by revoking access controls for your keys&mdash;doing so for disks attached to running VMs will cause the VMs to fail. Moreover, you can track the key usage through Key Vault monitoring to ensure that only Managed Disks or other trusted Azure services are accessing your keys.</p>\n\n<h2>Availability of SSE with CMK</h2>\n\n<p>SSE with CMK is available for Standard HDD, Standard SSD, and Premium SSD Managed Disks that can be attached to Azure Virtual Machines and VM scale sets. Ultra Disk Storage support will be announced separately. SSE with CMK is now enabled in all the public and Azure Government regions and will be available in the regions in Germany (Sovereign) and China in a few weeks.</p>\n\n<p>You can use Azure Backup to back up your VMs using Managed Disks encrypted with SSE with CMK. Also, you can choose to encrypt the backup data in your Recovery Services vaults using your keys stored in your Key Vault instead of platform-managed keys available by default. Refer to documentation for more details on the <a href=\"https://docs.microsoft.com/en-us/azure/backup/backup-azure-security-feature-cloud#encryption-of-backup-data-using-customer-managed-keys\" target=\"_blank\">encryption of backups using CMK</a>.</p>\n\n<p>You can use Azure Site Recovery to replicate your Azure virtual machines that have Managed Disks encrypted with SSE with CMK to other Azure regions for disaster recovery. You can also replicate your on-premises virtual machines to Managed Disks encrypted with SSE with CMK in Azure. Learn more about <a href=\"https://docs.microsoft.com/en-us/azure/site-recovery/azure-to-azure-how-to-enable-replication-cmk-disks\" target=\"_blank\">replicating your virtual machines using Managed Disks encrypted with SSE with CMK</a>.</p>\n\n<h2>Get started</h2>\n\n<p>To enable the encryption with CMK for Managed Disks, you must first create an instance of a new resource type called DiskEncryptionSet and then grant the instance access to the key Vault. DiskEncryptionSet represents a key in your Key Vault and allows you to reuse the same key for encrypting many disks, snapshots, and images with the same key.</p>\n\n<p>Let&rsquo;s look at an example of creating an instance of DiskEncryptionSet:</p>\n\n<p>1. Create an instance of DiskEncryptionSet by specifying a key in your Key Vault.</p>\n\n<p><code>keyVaultId=$(az keyvault show --name yourKeyVaultName --query [id] -o tsv)</code></p>\n\n<p><code>keyVaultKeyUrl=$(az keyvault key show --vault-name yourKeyVaultName --name yourKeyName --query [key.kid] -o tsv)</code></p>\n\n<p><code>az disk-encryption-set create -n yourDiskEncryptionSetName -l WestCentralUS -g yourResourceGroupName --source-vault $keyVaultId --key-url $keyVaultKeyUrl</code></p>\n\n<p>2. Grant the instance access to the Key Vault. When you created the instance, the system automatically created a <a href=\"https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview\" target=\"_blank\">system-assigned managed identity</a> in your Azure AD and associated the identity with the instance. The identity must have access to the Key Vault to perform required operations such as wrapkey, unwrapkey and get.</p>\n\n<p><code>desIdentity=$(az disk-encryption-set show -n yourDiskEncryptionSetName -g yourResourceGroupName --query [identity.principalId] -o tsv)</code></p>\n\n<p><code>az keyvault set-policy -n yourKeyVaultName -g yourResourceGroupName --object-id $desIdentity --key-permissions wrapkey unwrapkey get</code></p>\n\n<p><code>az role assignment create --assignee $desIdentity --role Reader --scope $keyVaultId</code></p>\n\n<p>You are ready to enable the encryption for disks, snapshots, and images by associating them with the instance of DiskEncryptionSet. There is no restriction on the number of resources that can be associated with the same DiskEncryptionSet.</p>\n\n<p>Let&rsquo;s look at an example of enabling for an existing disk:</p>\n\n<p>1. To enable the encryption for disks attached to a VM, you must stop(deallocate) a virtual machine.</p>\n\n<p><code>az vm stop --resource-group MyResourceGroup --name MyVm</code></p>\n\n<p>2. Enable the encryption for an attached disk by associating it with the instance of DiskEncryptionSet.</p>\n\n<p><code>diskEncryptionSetId=$(az disk-encryption-set show -n yourDiskEncryptionSetName -g yourResourceGroupName --query [id] -o tsv)</code></p>\n\n<p><code>az disk update -n yourDiskEncryptionSetName -g yourResourceGroupName --encryption-type EncryptionAtRestWithCustomerKey --disk-encryption-set $diskEncryptionSetId</code></p>\n\n<p>3. Start the VM.</p>\n\n<p><code>az vm start -g MyResourceGroup -n MyVm</code></p>\n\n<p>Refer to the <a href=\"https://docs.microsoft.com/en-us/azure/virtual-machines/windows/disk-encryption\" target=\"_blank\">Managed Disks documentation</a> for detailed instructions on enabling server side encryption with CMK for Managed Disks.</p>\n\n<h2>Send us your feedback</h2>\n\n<p>We look forward to hearing your feedback for SSE with CMK. Please email <a href=\"mailto:AzureDisks@microsoft.com\">us here</a>.&nbsp;</p>\n"
}