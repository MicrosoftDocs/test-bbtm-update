{
    "Slug": "analysis-of-network-connection-data-with-azure-monitor-for-virtual-machines",
    "Title": "Analysis of network connection data with Azure Monitor for virtual machines",
    "Summary": "Azure Monitor for virtual machines (VMs) collects network connection data that you can use to analyze the dependencies and network traffic of your VMs.",
    "Content": "<p>Azure Monitor for virtual machines (VMs) collects network connection data that you can use to analyze the dependencies and network traffic of your VMs. You can analyze the number of live and failed connections, bytes sent and received, and the connection dependencies of your VMs down to the process level. If malicious connections are detected it will include information about those IP addresses and threat level. The newly released <strong>VMBoundPort</strong> data set enables analysis of open ports and their connections for security analysis.</p>\n\n<p>To begin analyzing this data, you will need to be <a href=\"https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-onboard\" target=\"_blank\">on-boarded to Azure Monitor for VMs</a>.</p>\n\n<h2>Workbooks</h2>\n\n<p>If you would like to start your analysis with a prebuilt, editable report you can try out some of the Workbooks we ship with Azure Monitor for VMs. Once on-boarded you navigate to Azure Monitor and select <strong>Virtual Machines (preview)</strong> from the insights menu section. From here, you can navigate to the <strong>Performance or Map tab</strong> to see a link for <strong>View Workbook</strong> that will open the Workbook gallery which includes the following Workbooks that analyze our network data:</p>\n\n<ul>\n <li>Connections overview</li>\n <li>Failed connections</li>\n <li>TCP traffic</li>\n <li>Traffic comparison</li>\n <li>Active ports</li>\n <li>Open ports</li>\n</ul>\n\n<p>These editable reports let you analyze your connection data for a single VM, groups of VMs, and virtual machine scale sets.</p>\n\n<h2>Log Analytics</h2>\n\n<p>If you want to use Log Analytics to analyze the data, you can navigate to Azure Monitor and select <strong>Logs</strong> to begin querying the data. The logs view will show the name of the workspace that has been selected and the schema within that workspace. Under the<strong> ServiceMap </strong>data type you will find two tables:</p>\n\n<ul>\n <li>VMBoundPort</li>\n <li>VMConnection</li>\n</ul>\n\n<p>You can copy and paste the queries below into the Log Analytics query box to run them. Please note, you will need to edit a few of the examples below to provide the name of a computer that you want to query.</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f4803989-7e95-431a-8ec0-7487f2499176.png\"><img alt=\"Screenshot of copying and pasting queries into the Log Analytics query box\" border=\"0\" height=\"859\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/3bba4bf7-c087-4d77-84b1-547fcc9174ba.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Screenshot of copying and pasting queries into the Log Analytics query box\" width=\"1583\"></a></p>\n\n<h2>Common queries</h2>\n\n<p>Review the count of ports open on your VMs, which is useful when assessing which VMs configuration and security vulnerabilities.</p>\n\n<pre>\nVMBoundPort\n| where Ip != &quot;127.0.0.1&quot;\n| summarize by Computer, Machine, Port, Protocol\n| summarize OpenPorts=count() by Computer, Machine\n| order by OpenPorts desc</pre>\n\n<p>List the bound ports on your VMs, which is useful when assessing which VMs configuration and security vulnerabilities.</p>\n\n<pre>\nVMBoundPort\n| distinct Computer, Port, ProcessName</pre>\n\n<p>Analyze network activity by port to determine how your application or service is configured.</p>\n\n<pre>\nVMBoundPort\n| where Ip != &quot;127.0.0.1&quot;\n| summarize BytesSent=sum(BytesSent), BytesReceived=sum(BytesReceived), LinksEstablished=sum(LinksEstablished), LinksTerminated=sum(LinksTerminated), arg_max(TimeGenerated, LinksLive) by Machine, Computer, ProcessName, Ip, Port, IsWildcardBind\n| project-away TimeGenerated\n| order by Machine, Computer, Port, Ip, ProcessName</pre>\n\n<p>Bytes sent and received trends for your VMs.</p>\n\n<pre>\nVMConnection\n| summarize sum(BytesSent), sum(BytesReceived) by bin(TimeGenerated,1hr), Computer\n| order by Computer desc\n//| limit 5000\n| render timechart</pre>\n\n<p>If you have a lot of computers in your workspace, you may want to uncomment the limit statement in the example above. You can use the chart tools to view either bytes sent or received, and to filter down to specific computers.</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f88791f3-002a-464a-8fdb-74a468153a2e.png\"><img alt=\"Screenshot of chart tools being used to view Bytes sent or received\" border=\"0\" height=\"575\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/59117028-f2a7-4e56-8dde-082fea7321bc.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Screenshot of chart tools being used to view Bytes sent or received\" width=\"1046\"></a></p>\n\n<p>Connection failures over time, to determine if the failure rate is stable or changing.</p>\n\n<pre>\nVMConnection\n| where Computer == &lt;replace this with a computer name, e.g. &lsquo;acme-demo&rsquo;&gt;\n| extend bythehour = datetime_part(&quot;hour&quot;, TimeGenerated)\n| project bythehour, LinksFailed\n| summarize failCount = count() by bythehour\n| sort by bythehour asc\n| render timechart</pre>\n\n<p>Link status trends, to analyze the behavior and connection status of a machine.</p>\n\n<pre>\nVMConnection\n| where Computer == &lt;replace this with a computer name, e.g. &lsquo;acme-demo&rsquo;&gt;\n| summarize  dcount(LinksEstablished), dcount(LinksLive), dcount(LinksFailed), dcount(LinksTerminated) by bin(TimeGenerated, 1h)\n| render timechart</pre>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e3ff4bd7-e708-426d-a35f-b8622593c2f8.png\"><img alt=\"Screenshot of line chart showing query results from the last 24 hours\" border=\"0\" height=\"570\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/b308be9d-4320-43ec-b2cf-e153ebf2db98.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Screenshot of line chart showing query results from the last 24 hours\" width=\"1047\"></a></p>\n\n<h2>Getting started with log queries in Azure Monitor for VMs</h2>\n\n<p>To learn more about Azure Monitor for VMs, please read our overview, &ldquo;<a href=\"https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-overview\" target=\"_blank\">What is Azure Monitor for VMs (preview)</a>.&rdquo; If you are already using Azure Monitor for VMs, you can find additional example queries in our documentation for <a href=\"https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-log-search\" target=\"_blank\">querying data with Log Analytics</a>.</p>\n"
}