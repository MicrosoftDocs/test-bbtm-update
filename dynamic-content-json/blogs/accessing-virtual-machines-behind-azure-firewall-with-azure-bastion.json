{
    "Slug": "accessing-virtual-machines-behind-azure-firewall-with-azure-bastion",
    "Title": "Accessing virtual machines behind Azure Firewall with Azure Bastion",
    "Summary": "Azure Virtual Network enables a flexible foundation for building advanced networking architectures. Managing heterogeneous environments with various types of filtering components, such as Azure Firewall or your favorite network virtual appliance, requires a little bit of planning.",
    "Content": "<p>Azure Virtual Network enables a flexible foundation for building advanced networking architectures. Managing heterogeneous environments with various types of filtering components, such as Azure Firewall or your favorite network virtual appliance (NVA), requires a little bit of planning.</p>\n\n<p>Azure Bastion, which is <a href=\"https://azure.microsoft.com/en-us/blog/announcing-the-preview-of-microsoft-azure-bastion/\" target=\"_blank\">currently in preview</a>, is a fully managed platform as a service (PaaS) that provides secure and seamless remote desktop protocol (RDP) and secure shell (SSH) access to your virtual machines (VMs) directly through the Azure portal. Azure Bastion is provisioned directly in your virtual network, supporting all VMs attached without any exposure through public IP addresses.</p>\n\n<p>When you deploy Azure Firewall, or any NVA, you invariably force tunnel all traffic from your subnets. Applying a 0.0.0.0/0 user-defined route can lead to asymmetric routing for ingress and egress traffic to your workloads in your virtual network.</p>\n\n<p>While not trivial, you often find yourself creating and managing a growing set of network rules, including DS NAT, forwarding, and so on, for all your applications to resolve this. Although this can impact all your applications, RDP and SSH are the most common examples. In this scenario, the ingress traffic from the Internet may come directly to your virtual machine within your virtual network, but egress traffic will end up going to the NVA. Since most NVAs are stateful, it ends up dropping this traffic as it did not initially receive it.</p>\n\n<p>Azure Bastion, allows for simplified set up of RDP/SSH to your workloads within virtual networks containing stateful NVAs or Azure Firewall with force tunneling enabled. In this blog, we will look at how to make that work seamlessly.</p>\n\n<p style=\"text-align: center;\"><iframe allow=\"autoplay; encrypted-media\" allowfullscreen=\"\" frameborder=\"0\" height=\"315\" scrolling=\"no\" src=\"https://www.microsoft.com/en-us/videoplayer/embed/RE39JYA\" width=\"560\"></iframe></p>\n\n<ul>\n <li>For a reference on how to deploy Azure Bastion (preview) in your virtual network, please see the documentation &ldquo;<a href=\"https://docs.microsoft.com/en-us/azure/bastion/bastion-create-host-portal\" target=\"_blank\">Create an Azure Bastion host (Preview)</a>.&rdquo;</li>\n <li>To learn how to implement Azure Firewall in your virtual network, refer to the documentation &ldquo;<a href=\"https://docs.microsoft.com/en-us/azure/firewall/tutorial-firewall-deploy-portal\" target=\"_blank\">Deploy and configure Azure Firewall using the Azure portal</a>.&rdquo;</li>\n</ul>\n\n<p>Having deployed both Azure Bastion and Azure Firewall in your virtual network, let us look at how you can configure Azure Bastion to work in this scenario.</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e22d790b-e4f5-4f45-9dca-39528683a333.png\"><img alt=\"Azure Bastion architecture\" border=\"0\" height=\"563\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/66f4fbe8-a443-440f-b4a4-8b2de1c96fc8.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Azure Bastion architecture\" width=\"1024\"></a></p>\n\n<h2>Configuring Azure Bastion</h2>\n\n<p>When deploying Azure Firewall, or a virtual appliance, you may end up associating your <strong>RouteTable</strong>, which was created while deploying Azure Firewall, to all subnets in your virtual network. You may even be including the <strong>AzureBastionSubnet</strong> subnet as well.&nbsp;</p>\n\n<p>This applies a user-defined route to the AzureBastionSubnet subnet which directs all Azure Bastion traffic to Azure Firewall, thereby blocking traffic required for Azure Bastion. To avoid this, configuring Azure Bastion is very easy, but do not associate the <strong>RouteTable</strong> to <strong>AzureBastionSubnet</strong> subnet.</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/2c59a68a-72bf-440b-8a60-790af4ee09b5.png\"><img alt=\"myRoute table in Microsoft Azure\" border=\"0\" height=\"1141\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/fbb546cb-7244-479d-917b-6461cd14e326.png\" style=\"border: 0px currentcolor; border-image: none; display: inline; background-image: none;\" title=\"myRoute table in Microsoft Azure\" width=\"3000\"></a></p>\n\n<p>As you would have noticed above, <strong>myRouteTable</strong> is not associated with the <strong>AzureBastionSubnet</strong>, but with other subnets like <strong>Workload-SN</strong>.</p>\n\n<p>The <strong>AzureBastionSubnet</strong> subnet is secure platform managed subnet, and no other Azure Resource can deploy in this subnet except Azure Bastion. All connections to Azure Bastion are enforced through the Azure Active Directory token-based authentication with 2FA, and all traffic is encrypted/over HTTPS.&nbsp;</p>\n\n<p>Azure Bastion is internally hardened and allows traffic only through port 443, saving you the task of applying additional network security groups (NSGs) or user-defined routes to the subnet.</p>\n\n<p>With this, the RDP/SSH requests will land on Azure Bastion. Configured using the example above, the default route (0.0.0.0/0) does not apply to <strong>AzureBastionSubnet</strong> as it&#39;s not associated with this subnet. Based on the incoming RDP/SSH requests, Azure Bastion connects to your virtual machines in other subnets, like Workload-SN, which do have a default route associated. The return traffic from your virtual machine will go directly to Azure Bastion, instead of going to the NVA, in your virtual network as the return traffic is directed to a specific private IP in your virtual network. The specific private IP address in your virtual network makes it a more specific route and hence, takes precedence over the force-tunnel route to the NVA, making your RDP/SSH traffic work seamlessly with Azure Bastion when a NVA or Azure Firewall is deployed in your virtual network.</p>\n\n<p>We are grateful and appreciate the engagement and excitement of customers and community and are looking forward to your <a href=\"https://feedback.azure.com/forums/922378-azure-bastion\" target=\"_blank\">feedback</a> in further improving the service and making it generally available soon.</p>\n"
}