{
    "Slug": "advancing-azure-active-directory-availability",
    "Title": "Advancing Azure Active Directory availability",
    "Summary": "Continuing our Azure reliability series to be as transparent as possible about key initiatives underway to keep improving availability, today we turn our attention to Azure Active Directory",
    "Content": "<p>&ldquo;Continuing our <a href=\"https://www.aka.ms/advancingreliability\" target=\"_blank\">Azure reliability series</a> to be as transparent as possible about key initiatives underway to keep improving availability, today we turn our attention to Azure Active Directory. Microsoft Azure Active Directory (Azure AD) is a cloud identity service that provides secure access to over 250 million monthly active users, connecting over 1.4 million unique applications and processing over 30 billion daily authentication requests. This makes Azure AD not only the largest enterprise Identity and Access Management solution, but easily one of the world&rsquo;s largest services. The post that follows was written by Nadim Abdo, Partner Director of Engineering, who is leading these efforts.&rdquo; - Mark Russinovich, CTO, Azure</p>\n\n<hr>\n<p>&nbsp;</p>\n\n<p>Our customers trust Azure AD to manage secure access to all their applications and services. For us, this means that every authentication request is a mission critical operation. Given the critical nature and the scale of the service, our identity team&rsquo;s top priority is the reliability and security of the service. Azure AD is engineered for availability and security using a truly cloud-native, hyper-scale, multi-tenant architecture and our team has a continual program of raising the bar on reliability and security.</p>\n\n<h2>Azure AD: Core availability principles</h2>\n\n<p>Engineering a service of this scale, complexity, and mission criticality to be highly available in a world where everything we build on can and does fail is a complex task.</p>\n\n<p>Our resilience investments are organized around the set of reliability principles below:</p>\n\n<p><img alt=\"o\tAzure AD resilience investments are organized around this set of reliability principles\" border=\"0\" height=\"295\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/79639571-4f8a-49d3-ba27-6244be5994b2.png\" style=\"border: 0px currentcolor; border-image: none; display: inline; background-image: none;\" title=\"\" width=\"624\"></p>\n\n<p>Our availability work adopts a layered defense approach to reduce the possibility of customer visible failure as much as possible; if a failure does occur, scope down the impact of that failure as much as possible, and finally, reduce the time it takes to recover and mitigate a failure as much as possible.</p>\n\n<p>Over the coming weeks and months, we dive deeper into how each of the principles is designed and verified in practice, as well as provide examples of how they work for our customers.</p>\n\n<h2>Highly redundant</h2>\n\n<p>Azure AD is a global service with multiple levels of internal redundancy and automatic recoverability. Azure AD is deployed in over 30 datacenters around the world leveraging Azure Availability Zones where present. This number is growing rapidly as additional Azure Regions are deployed.</p>\n\n<p>For durability, any piece of data written to Azure AD is replicated to at least 4 and up to 13 datacenters depending on your tenant configuration. Within each data center, data is again replicated at least 9 times for durability but also to scale out capacity to serve authentication load. To illustrate&mdash;this means that at any point in time, there are at least 36 copies of your directory data available within our service in our smallest region. For durability, writes to Azure AD are not completed until a successful commit to an out of region datacenter.</p>\n\n<p>This approach gives us both durability of the data and massive redundancy&mdash;multiple network paths and datacenters can serve any given authorization request, and the system automatically and intelligently retries and routes around failures both inside a datacenter and across datacenters.</p>\n\n<p>To validate this, we regularly exercise fault injection and validate the system&rsquo;s resiliency to failure of the system components Azure AD is built on. This extends all the way to taking out entire datacenters on a regular basis to confirm the system can tolerate the loss of a datacenter with zero customer impact.</p>\n\n<h2>No single points of failure (SPOF)</h2>\n\n<p>As mentioned, Azure AD itself is architected with multiple levels of internal resilience, but our principle extends even further to have resilience in all our external dependencies. This is expressed in our no single point of failure (SPOF) principle.</p>\n\n<p>Given the criticality of our services we don&rsquo;t accept SPOFs in critical external systems like Distributed Name Service (DNS), content delivery networks (CDN), or Telco providers that transport our multi-factor authentication (MFA), including SMS and Voice. For each of these systems, we use multiple redundant systems configured in a full active-active configuration.</p>\n\n<p>Much of that work on this principle has come to completion over the last calendar year, and to illustrate, when a large DNS provider recently had an outage, Azure AD was entirely unaffected because we had an active/active path to an alternate provider.</p>\n\n<h2>Elastically scales</h2>\n\n<p>Azure AD is already a massive system running on over 300,000 CPU Cores and able to rely on the massive scalability of the Azure Cloud to dynamically and rapidly scale up to meet any demand. This can include both natural increases in traffic, such as a 9AM peak in authentications in a given region, but also huge surges in new traffic served by our Azure AD B2C which powers some of the world&rsquo;s largest events and frequently sees rushes of millions of new users.</p>\n\n<p>As an added level of resilience, Azure AD over-provisions its capacity and a design point is that the failover of an entire datacenter does not require any additional provisioning of capacity to handle the redistributed load. This gives us the flexibility to know that in an emergency we already have all the capacity we need on hand.</p>\n\n<h2>Safe deployment</h2>\n\n<p>Safe deployment ensures that changes (code or configuration) progress gradually from internal automation to internal to Microsoft self-hosting rings to production. Within production we adopt a very graduated and slow ramp up of the percentage of users exposed to a change with automated health checks gating progression from one ring of deployment to the next. This entire process takes over a week to fully rollout a change across production and can at any time rapidly rollback to the last well-known healthy state.</p>\n\n<p>This system regularly catches potential failures in what we call our &lsquo;early rings&rsquo; that are entirely internal to Microsoft and prevents their rollout to rings that would impact customer/production traffic.</p>\n\n<h2>Modern verification</h2>\n\n<p>To support the health checks that gate safe deployment and give our engineering team insight into the health of the systems, Azure AD emits a massive amount of internal telemetry, metrics, and signals used to monitor the health of our systems. At our scale, this is over 11 PetaBytes a week of signals that feed our automated health monitoring systems. Those systems in turn trigger alerting to automation as well as our team of 24/7/365 engineers that respond to any potential degradation in availability or Quality of Service (QoS).</p>\n\n<p>Our journey here is expanding that telemetry to provide optics of not just the health of the services, but metrics that truly represent the end-to-end health of a given scenario for a given tenant. Our team is already alerting on these metrics internally and we&rsquo;re evaluating how to expose this per-tenant health data directly to customers in the Azure Portal.</p>\n\n<h2>Partitioning and fine-grained fault domains</h2>\n\n<p>A good analogy to better understand Azure AD are the compartments in a submarine, designed to be able to flood without affecting either other compartments or the integrity of the entire vessel.</p>\n\n<p>The equivalent for Azure AD is a fault domain, the scale units that serve a set of tenants in a fault domain are architected to be completely isolated from other fault domain&rsquo;s scale units. These fault domains provide hard isolation of many classes of failures such that the &lsquo;blast radius&rsquo; of a fault is contained in a given fault domain.</p>\n\n<p>Azure AD up to now has consisted of five separate fault domains. Over the last year, and completed by next summer, this number will increase to 50 fault domains, and many services, including Azure Multi-Factor Authentication (MFA), are moving to become fully isolated in those same fault domains.</p>\n\n<p>This hard-partitioning work is designed to be a final catch all that scopes any outage or failure to no more than 1/50 or ~2% of our users. Our objective is to increase this even further to hundreds of fault domains in the following year.</p>\n\n<h2>A preview of what&rsquo;s to come</h2>\n\n<p>The principles above aim to harden the core Azure AD service. Given the critical nature of Azure AD, we&rsquo;re not stopping there&mdash;future posts will cover new investments we&rsquo;re making including rolling out in production a second and completely fault-decorrelated identity service that can provide seamless fallback authentication support in the event of a failure in the primary Azure AD service.</p>\n\n<p>Think of this as the equivalent to a backup generator or uninterruptible power supply (UPS) system that can provide coverage and protection in the event the primary power grid is impacted. This system is completely transparent and seamless to end users and is now in production protecting a portion of our critical authentication flows for a set of M365 workloads. We&rsquo;ll be rapidly expanding its applicability to cover more scenarios and workloads.</p>\n\n<p>We look forward to sharing more on our <a href=\"https://www.aka.ms/identityblog\" target=\"_blank\">Azure Active Directory Identity Blog</a>, hearing your questions and topics of interest for future posts.</p>\n"
}